<!DOCTYPE html>
<html lang="en">
    <head>
        <script type="text/javascript" charset="utf-8" async="" src="https://ssl.p.jwpcdn.com/player/v/8.21.1/jwpsrv.js"></script>
        <script type="text/javascript" charset="utf-8" async="" src="https://ssl.p.jwpcdn.com/player/plugins/vast/v/8.9.5/vast.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
        <script charset="utf-8" src="https://ssl.p.jwpcdn.com/player/v/8.21.1/jwplayer.core.controls.js"></script>
        <script charset="utf-8" src="https://ssl.p.jwpcdn.com/player/v/8.21.1/provider.hlsjs.js"></script>
        <link rel="stylesheet" href="jwplayer.css">
        <style type="text/css" data-jwplayer-id="all-players">
			body {
				margin: 0;
				padding: 0;
                overflow: hidden;
                background-color: black;
			}
            .jw-logo {
                opacity: .5;
                width: 15vmax !important;
                top: 2vmax !important;
                right: 2vmax !important;
                transition: .2s;
            }
            .jw-logo:hover { opacity: 1; }
            .wrap, #player {
                position: absolute;
                width: 100vw !important;
                height: 100vh !important;
            }
            .wrap .btn {
                position: absolute;
                top: 15%;
                left: 90%;
                transform: translate(-50%, -50%);
                -ms-transform: translate(-50%, -50%);
                background-color: white;
                color: black;
                font-size: 12px;
                padding: 6px 12px;
                border: 1px solid white;
                cursor: pointer;
                border-radius: 5px;
            }
            .jw-slider-horizontal .jw-cue {
                background-color: white !important;
            }
            .jw-knob { z-index: 10; }
            @media screen and (max-width:600px) { .wrap .btn { font-size: 08px; } }
        </style>
        <script charset="utf-8" src="https://ssl.p.jwpcdn.com/player/v/8.21.1/provider.cast.js"></script>
    </head>
    <body>
        <div class="wrap">
            <div id="player"></div>
        </div>
        <script src="jwplayer.js"></script>
        <script>
            let urlParams = new URLSearchParams(window.location.search), json = {
                f: urlParams.get("f"),
                t: urlParams.get("t"),
                i: JSON.parse(urlParams.get("i")),
                co: JSON.parse(urlParams.get("co")),
                nm: urlParams.get("nm"),
                ep: urlParams.get("ep")
            }, data = {
                file: json.f.includes("/") ? json.f : "https://fds.biananset.net/_v7/" + json.f + "/master.m3u8",
                tracks: json.t ? [{ file: "https://cc.bunnyccdn.co/" + json.t, label: "Хадмал", default: true }] : [],
                intro: { start: json.i[0], end: json.i[1] },
                outro: { start: json.i[2], end: json.i[3] },
                title: json.nm,
                description: json.ep + "-р анги",
                controls: json.co,
                logo: "",
                about: "AniGT"
            }, cues = [];
            if (data.intro && (data.intro.start != 0 || data.intro.end != 0)) {
                cues.push({ begin: data.intro.start, text: "Intro Start" });
                cues.push({ begin: data.intro.end, text: "Intro End" });
            }
            if (data.outro && (data.outro.start != 0 || data.outro.end != 0)) {
                cues.push({ begin: data.outro.start, text: "Outro Start" });
                cues.push({ begin: data.outro.end, text: "Outro End" });
            }
            initPlayer(data);
            function updateControls(c) { data.controls = c; }
            function initPlayer(data) {
                const playerInstance = jwplayer("player").setup({
                    controls: true,
                    displaytitle: true,
                    displaydescription: true,
                    abouttext: data.about || "",
                    aboutlink: data.aboutLink || "#",
                    autostart: data.controls[0],
                    mute: data.controls[0],
                    skin: { name: "netflix" },
                    logo: {
                        file: data.logo || "",
                        link: data.logoLink || "#",
                    },
                    playlist: [{
                        title: data.title || "",
                        description: data.description || "",
                        image: data.image || "",
                        file: data.file || "",
                        tracks: data.tracks || [],
                    }],
                    advertising: {
                        client: "vast",
                        schedule: [...Array(data.adCount || 0).keys()].map(i => { return {
                            offset: i == 0 ? "pre" : Math.round(100 * i / data.adCount) + "%",
                            tag: data.ad || "",
                            skipoffset: data.adSkip || 5
                        }; })
                    },
                    playbackRates: [0.5, 1, 1.25, 1.5, 2, 2.5, 3]
                });
                playerInstance.setPlaybackRate(parseFloat(window.localStorage.getItem("playerRate") || "1"));
                playerInstance.setVolume(parseFloat(window.localStorage.getItem("playerVolume") || "100"));
                playerInstance.on("time", e => {
                    if (data.controls[2]) {
                        if (data.intro && data.intro.start <= e.position && e.position < data.intro.end)
                            playerInstance.seek(data.intro.end);
                        if (data.outro && data.outro.start <= e.position && e.position < data.outro.end)
                            playerInstance.seek(data.outro.end);
                    }
                });
                playerInstance.on("play", () => {
                    if (cues.length > 0 && playerInstance.getCues().length == 0)
                        playerInstance.setCues(cues);
                });
                playerInstance.on("complete", () => {
                    if (data.controls[1])
                        window.parent.window.next();
                });
                playerInstance.on("playbackRateChanged", () => {
                    window.localStorage.setItem("playerRate", playerInstance.getPlaybackRate());
                });
                playerInstance.on("volume", () => {
                    window.localStorage.setItem("playerVolume", playerInstance.getVolume());
                });
                playerInstance.on("ready", () => {
                    // Move the timeslider in-line with other controls
                    const playerContainer = playerInstance.getContainer();
                    const buttonContainer = playerContainer.querySelector(".jw-button-container");
                    const spacer = buttonContainer.querySelector(".jw-spacer");
                    const timeSlider = playerContainer.querySelector(".jw-slider-time");
                    buttonContainer.replaceChild(timeSlider, spacer);
                    const player = playerInstance;
                    // display icon
                    const rewindContainer = playerContainer.querySelector(".jw-display-icon-rewind");
                    const forwardContainer = rewindContainer.cloneNode(true);
                    const forwardDisplayButton = forwardContainer.querySelector(".jw-icon-rewind");
                    forwardDisplayButton.style.transform = "scaleX(-1)";
                    forwardDisplayButton.ariaLabel = "Forward 10 Seconds"
                    const nextContainer = playerContainer.querySelector(".jw-display-icon-next");
                    nextContainer.parentNode.insertBefore(forwardContainer, nextContainer);
                    // control bar icon
                    playerContainer.querySelector(".jw-display-icon-next").style.display = "none"; // hide next button
                    const rewindControlBarButton = buttonContainer.querySelector(".jw-icon-rewind");
                    rewindControlBarButton.ariaLabel = "Backward 10 Seconds";
                    const forwardControlBarButton = rewindControlBarButton.cloneNode(true);
                    forwardControlBarButton.style.transform = "scaleX(-1)";
                    forwardControlBarButton.ariaLabel = "Forward 10 Seconds";
                    rewindControlBarButton.parentNode.insertBefore(forwardControlBarButton, rewindControlBarButton.nextElementSibling);
                    // add onclick handlers
                    [forwardDisplayButton, forwardControlBarButton].forEach(button => {
                        button.onclick = () => {
                            player.seek((player.getPosition() + 10));
                        }
                    });
                    // New Features
                    if (data.controls[0]) {
                        let interval = setInterval(() => {
                            if (document.getElementsByClassName("jw-icon-fullscreen")[0]) {
                                playerInstance.setFullscreen(true);
                                playerInstance.setFullscreen(false);
                                clearInterval(interval);
                            }
                        }, 100);
                    }
                    if (data.tracks.length > 0) {
                        const letters = {
                            "a":"а","b":"б","c":"ц","d":"д","e":"э","f":"ф","g":"г","h":"х","i":"и","j":"ж","k":"к","l":"л","m":"м","n":"н","o":"о","p":"р","q":"к","r":"р","s":"с","t":"т","u":"у","v":"в","w":"в","x":"кс","y":"я","z":"з",
                            "ya":"яа","ye":"еэ","yi":"еи","yo":"ёо","yu":"юу","cha":"ча","che":"чэ","chi":"чи","cho":"чо","chu":"чу","sha":"ша","she":"шэ","shi":"ши","sho":"шо","shu":"шу","tsa":"ца","tse":"цэ","tsi":"ци","tso":"цо","tsu":"цу"
                        }, noCC = "・", ccPar = document.getElementsByClassName("jw-captions")[0];
                        let lines = {};
                        const observer = new MutationObserver(() => {
                            if (ccPar.firstElementChild)
                                [...ccPar.firstElementChild.children].forEach(e => {
                                    if (data.controls[3] && !e.getAttribute("style").includes("left: 0; right: 0;")) {
                                        e.setAttribute("style", e.getAttribute("style").replace(/left: \d+(\.\d+)?px;/, "left: 0; right: 0;"));
                                        translate(e.firstElementChild);
                                    }
                                });
                        });
                        observer.observe(ccPar, { subtree: true, childList: true });
                        function translate(cc) {
                            let line = cc.innerHTML.replaceAll(/<[^>]*>/g, "").split("\n");
                            line = data.controls[4] ? line.map(e => e.trim()).join(" ").trim() : line.map(e => e.replaceAll(/\[.*?\]/g, "").replaceAll(/-[- ]/g, "").trim()).join(" ").trim();
                            cc.style.display = "inline";
                            if (line == "") {
                                cc.style.display = "none";
                            } else if (line in letters) {
                                translateShow(cc, letters[line]);
                            } else if (/^[a-z][a-z]$/g.test(line)) {
                                translateShow(cc, letters[line[0]] + letters[line[1]]);
                            } else if (line in lines) {
                                translateShow(cc, lines[line]);
                            } else if (/^[^a-zA-Z]+$/g.test(line) || line.startsWith(noCC) && line.endsWith(noCC) || Object.values(lines).includes(line)) {
                                translateShow(cc, line);
                            } else {
                                cc.style.display = "none";
                                googleTranslate(line, translated => {
                                    cc.style.display = "inline";
                                    translateShow(cc, translated);
                                    if (!(translated.startsWith(noCC) && translated.endsWith(noCC))) lines[line] = translated;
                                });
                            }
                        }
                        function translateShow(cc, line) {
                            if (cc.innerHTML.split("\n").length > 1) {
                                let i = Math.floor(line.length / 2);
                                i += /[ \.,?!'"-]/.exec(line.substring(i)).index;
                                line = line.substring(0, i + 1).trim() + "\n" + line.substring(i + 1).trim();
                            }
                            cc.innerHTML = line;
                        }
                        function googleTranslate(str, callback) {
                            fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=mn&dt=t&q=" + encodeURIComponent(str)).then(e => e.json()).then(e => callback(e[0].map(e => e[0].trim()).join(" "))).catch(e => callback(noCC + str + noCC));
                        }
                    }
                });
            }
        </script>
    </body>
</html>